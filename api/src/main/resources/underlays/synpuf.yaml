# An initial OMOP underlay schema on the SynPUFs OMOP dataset for development.

name: synpuf
entities:
  - name: person
    attributes:
      - name: person_id
        dataType: INT64
      - name: gender_concept_id
        dataType: INT64
      - name: gender
        dataType: STRING
      - name: race_concept_id
        dataType: INT64
      - name: race
        dataType: STRING
      - name: ethnicity_concept_id
        dataType: INT64
      - name: ethnicity
        dataType: STRING
  - name: condition_occurrence
    attributes:
      - name: condition_occurrence_id
        dataType: INT64
      - name: person_id
        dataType: INT64
      - name: condition_concept_id
        dataType: INT64
      - name: condition_name
        dataType: STRING
      - name: condition_standard
        dataType: STRING
      - name: condition_concept_code
        dataType: STRING
  - name: concept
    attributes:
      - name: concept_id
        dataType: INT64
      - name: concept_name
        dataType: STRING
      - name: domain_id
        dataType: STRING
      - name: vocabulary_id
        dataType: STRING
      - name: vocabulary_name
        dataType: STRING
      - name: standard_concept
        dataType: STRING
      - name: concept_code
        dataType: STRING
criteriaConfigs: >-
  [{"type":"concept",
  "title":"Conditions",
  "defaultName":"Contains Conditions Codes",
  "plugin":{"columns":[{"key":"concept_name","width":"100%","title":"Concept Name"},{"key":"concept_id","width":120,"title":"Concept ID"},{"key":"standard_concept","width":180,"title":"SourceStandard"},{"key":"vocabulary_id","width":120,"title":"Vocab"},{"key":"concept_code","width":120,"title":"Code"}],
  "entities":[{"name":"condition","selectable":true,"hierarchical":true}]}},
  
  {"type":"concept",
  "title":"Procedures",
  "defaultName":"Contains Procedures Codes",
  "plugin":{"columns":[{"key":"concept_name","width":"100%","title":"Concept Name"},{"key":"concept_id","width":120,"title":"Concept ID"},{"key":"standard_concept","width":180,"title":"SourceStandard"},{"key":"vocabulary_id","width":120,"title":"Vocab"},{"key":"concept_code","width":120,"title":"Code"}],
  "entities":[{"name":"procedure","selectable":true,"hierarchical":true}]}},
  
  {"type":"concept",
  "title":"Observations",
  "defaultName":"Contains Observations Codes",
  "plugin":{"columns":[{"key":"concept_name","width":"100%","title":"Concept Name"},{"key":"concept_id","width":120,"title":"Concept ID"},{"key":"standard_concept","width":180,"title":"SourceStandard"},{"key":"vocabulary_id","width":120,"title":"Vocab"},{"key":"concept_code","width":120,"title":"Code"}],
  "entities":[{"name":"observation","selectable":true}]}},
  
  {"type":"concept",
  "title":"Drugs",
  "defaultName":"Contains Drugs Codes",
  "plugin":{"columns":[{"key":"concept_name","width":"100%","title":"Concept Name"},{"key":"concept_id","width":120,"title":"Concept ID"},{"key":"standard_concept","width":180,"title":"SourceStandard"},{"key":"vocabulary_id","width":120,"title":"Vocab"},{"key":"concept_code","width":120,"title":"Code"}],
  "entities":[
  {"name":"ingredient","selectable":true,"hierarchical":true},
  {"name":"brand",
  "sourceConcepts":true,
  "attributes":["concept_name","concept_id","standard_concept","concept_code"],
  "listChildren":{"entity":"ingredient","idPath":"relationshipFilter.filter.binaryFilter.attributeValue","filter":{"relationshipFilter":{"outerVariable":"ingredient","newVariable":"brand","newEntity":"brand","filter":{"binaryFilter":{"attributeVariable":{"variable":"brand","name":"concept_id"},"operator":"EQUALS","attributeValue":{"int64Val":0}}}}}}}]}},
  
  {"type":"attribute",
  "title":"Ethnicity",
  "defaultName":"Contains Ethnicity Codes",
  "plugin":{"attribute":"ethnicity_concept_id"}},
  
  {"type":"attribute",
  "title":"Gender Identity",
  "defaultName":"Contains Gender Identity Codes",
  "plugin":{"attribute":"gender_concept_id"}},
  
  {"type":"attribute",
  "title":"Race",
  "defaultName":"Contains Race Codes",
  "plugin":{"attribute":"race_concept_id"}},
  
  {"type":"attribute",
  "title":"Sex Assigned at Birth",
  "defaultName":"Contains Sex Assigned at Birth Codes",
  "plugin":{"attribute":"sex_at_birth_concept_id"}},
  
  {"type":"attribute",
  "title":"Year at Birth",
  "defaultName":"Contains Year at Birth Values",
  "plugin":{"attribute":"year_of_birth"}}]"
relationships:
  - name: person_condition_occurrence
    entity1: person
    entity2: condition_occurrence
  - name: concept_id_person_gender
    entity1: concept
    entity2: person
  - name: concept_id_person_race
    entity1: concept
    entity2: person
  - name: concept_id_person_ethnicity
    entity1: concept
    entity2: person
  - name: concept_id_person_sex_at_birth
    entity1: concept
    entity2: person
  - name: concept_id_condition
    entity1: concept
    entity2: condition_occurrence
datasets:
  - name: omop_test
    bigQueryDataset:
      projectId: broad-tanagra-dev
      datasetId: synpuf
    tables:
      - name: person
        columns:
          - name: person_id
            dataType: INT64
          - name: gender_concept_id
            dataType: INT64
          - name: race_concept_id
            dataType: INT64
          - name: ethnicity_concept_id
            dataType: INT64
      - name: condition_occurrence
        columns:
          - name: condition_occurrence_id
            dataType: INT64
          - name: person_id
            dataType: INT64
          - name: condition_concept_id
            dataType: INT64
      - name: concept
        columns:
          - name: concept_id
            dataType: INT64
          - name: concept_name
            dataType: STRING
          - name: domain_id
            dataType: STRING
          - name: standard_concept
            dataType: STRING
          - name: vocabulary_id
            dataType: STRING
          - name: concept_code
            dataType: STRING
      - name: vocabulary
        columns:
          - name: vocabulary_id
            dataType: STRING
          - name: vocabulary_name
            dataType: STRING
      - name: concept_relationship
        columns:
          - name: concept_id_1
            dataType: INT64
          - name: concept_id_2
            dataType: INT64
          - name: relationship_id
            dataType: STRING
  - name: omop_indexes
    bigQueryDataset:
      projectId: broad-tanagra-dev
      datasetId: synpuf_indexes
    tables:
      - name: flatten_snomed_conditions_0
        columns:
          - name: ancestor
            dataType: INT64
          - name: descendant
            dataType: INT64
      - name: concept_ancestor_descendant_1
        columns:
          - name: ancestor
            dataType: INT64
          - name: descendant
            dataType: INT64
      - name: concept_node_path_1
        columns:
          - name: node
            dataType: INT64
          - name: path
            dataType: STRING
entityMappings:
  - entity: person
    primaryKey:
      dataset: omop_test
      table: person
      column: person_id
  - entity: condition_occurrence
    primaryKey:
      dataset: omop_test
      table: condition_occurrence
      column: condition_occurrence_id
  - entity: concept
    primaryKey:
      dataset: omop_test
      table: concept
      column: concept_id
attributeMappings:
  - attribute:
      entity: person
      attribute: person_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: person_id
  - attribute:
      entity: person
      attribute: gender_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: gender_concept_id
  - attribute:
      entity: person
      attribute: gender
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: gender_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: person
      attribute: race_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: race_concept_id
  - attribute:
      entity: person
      attribute: race
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: race_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: person
      attribute: ethnicity_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
  - attribute:
      entity: person
      attribute: ethnicity
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: condition_occurrence
      attribute: condition_occurrence_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: condition_occurrence_id
  - attribute:
      entity: condition_occurrence
      attribute: person_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: person_id
  - attribute:
      entity: condition_occurrence
      attribute: condition_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
  - attribute:
      entity: condition_occurrence
      attribute: condition_name
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: condition_occurrence
      attribute: condition_standard
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: standard_concept
  - attribute:
      entity: condition_occurrence
      attribute: condition_concept_code
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_code
  - attribute:
      entity: concept
      attribute: concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_id
  - attribute:
      entity: concept
      attribute: concept_name
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: concept
      attribute: domain_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: domain_id
  - attribute:
      entity: concept
      attribute: vocabulary_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: vocabulary_id
  - attribute:
      entity: concept
      attribute: vocabulary_name
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: concept
        column: vocabulary_id
      lookupTableKey:
        dataset: omop_test
        table: vocabulary
        column: vocabulary_id
      lookupColumn:
        dataset: omop_test
        table: vocabulary
        column: vocabulary_name
  - attribute:
      entity: concept
      attribute: standard_concept
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: standard_concept
  - attribute:
      entity: concept
      attribute: concept_code
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_code
relationshipMappings:
  - name: person_condition_occurrence
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: person
        column: person_id
      foreignKey:
        dataset: omop_test
        table: condition_occurrence
        column: person_id
  - name: concept_id_person_gender
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: gender_concept_id
  - name: concept_id_person_race
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: race_concept_id
  - name: concept_id_person_ethnicity
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
  - name: concept_id_condition
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
