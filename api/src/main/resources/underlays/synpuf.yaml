# An initial OMOP underlay schema on the SynPUFs OMOP dataset for development.

name: synpuf
entities:
  - name: person
    attributes:
      - name: person_id
        dataType: INT64
      - name: gender_concept_id
        dataType: INT64
      - name: gender
        dataType: STRING
      - name: race_concept_id
        dataType: INT64
      - name: race
        dataType: STRING
      - name: ethnicity_concept_id
        dataType: INT64
      - name: ethnicity
        dataType: STRING
  - name: condition_occurrence
    attributes:
      - name: condition_occurrence_id
        dataType: INT64
      - name: person_id
        dataType: INT64
      - name: condition_concept_id
        dataType: INT64
      - name: condition_name
        dataType: STRING
      - name: condition_standard
        dataType: STRING
      - name: condition_concept_code
        dataType: STRING
  - name: concept
    attributes:
      - name: concept_id
        dataType: INT64
      - name: concept_name
        dataType: STRING
      - name: domain_id
        dataType: STRING
      - name: vocabulary_id
        dataType: STRING
      - name: vocabulary_name
        dataType: STRING
      - name: standard_concept
        dataType: STRING
      - name: concept_code
        dataType: STRING
uiConfiguration: >-
  {
    "dataConfig": {
      "primaryEntity": {
        "displayName": "Person",
        "entity": "person",
        "key": "person_id"
      },
      "occurrences": [
        {
          "id": "condition_occurrence",
          "displayName": "Condition Occurrences",
          "entity": "condition_occurrence",
          "key": "condition_concept_id",
          "classifications": [
            {
              "id": "condition",
              "name": "Conditions",
              "attribute": "condition_concept_id",
              "entity": "condition",
              "entityAttribute": "concept_id",
              "hierarchical": true,
              "defaultSort": {
                "attribute": "person_count",
                "direction": "DESC"
              },
              "filter": {
                "binaryFilter": {
                  "attributeVariable": {
                    "name": "standard_concept",
                    "variable": "condition"
                  },
                  "operator": "NOT_EQUALS"
                }
              }
            }
          ]
        },
        {
          "id": "procedure_occurrence",
          "displayName": "Procedure Occurrences",
          "entity": "procedure_occurrence",
          "key": "procedure_concept_id",
          "classifications": [
            {
              "id": "procedure",
              "name": "Procedures",
              "attribute": "procedure_concept_id",
              "entity": "procedure",
              "entityAttribute": "concept_id",
              "hierarchical": true,
              "defaultSort": {
                "attribute": "person_count",
                "direction": "DESC"
              },
              "filter": {
                "binaryFilter": {
                  "attributeVariable": {
                    "name": "standard_concept",
                    "variable": "procedure"
                  },
                  "operator": "NOT_EQUALS"
                }
              }
            }
          ]
        },
        {
          "id": "observation_occurrence",
          "displayName": "Observation Occurrence",
          "entity": "observation_occurrence",
          "key": "observation_concept_id",
          "classifications": [
            {
              "id": "observation",
              "name": "Observation",
              "attribute": "observation_concept_id",
              "entity": "observation",
              "entityAttribute": "concept_id",
              "defaultSort": {
                "attribute": "person_count",
                "direction": "DESC"
              },
              "filter": {
                "binaryFilter": {
                  "attributeVariable": {
                    "name": "standard_concept",
                    "variable": "observation"
                  },
                  "operator": "NOT_EQUALS"
                }
              }
            }
          ]
        },
        {
          "id": "ingredient_occurrence",
          "displayName": "Drug Occurrence",
          "entity": "ingredient_occurrence",
          "key": "drug_concept_id",
          "classifications": [
            {
              "id": "ingredient",
              "name": "Ingredient",
              "attribute": "drug_concept_id",
              "entity": "ingredient",
              "entityAttribute": "concept_id",
              "hierarchical": true,
              "defaultSort": {
                "attribute": "person_count",
                "direction": "DESC"
              },
              "filter": {
                "binaryFilter": {
                  "attributeVariable": {
                    "name": "standard_concept",
                    "variable": "ingredient"
                  },
                  "operator": "NOT_EQUALS"
                }
              },
              "groupings": [
                {
                  "id": "brand",
                  "name": "Brand",
                  "entity": "brand",
                  "defaultSort": {
                    "attribute": "concept_name",
                    "direction": "ASC"
                  }
                }
              ]
            }
          ]
        }
      ]
    },
    "criteriaConfigs": [{
      "type":"classification",
      "id": "tanagra-conditions",
      "title":"Condition",
      "conceptSet": true,
      "category": "Domains",
      "columns": [
        {"key":"concept_name","width":"100%","title":"Concept name"},
        {"key":"concept_id","width":100,"title":"Concept ID"},
        {"key":"standard_concept","width":120,"title":"Source/standard"},
        {"key":"vocabulary_id","width":120,"title":"Vocab"},
        {"key":"concept_code","width":120,"title":"Code"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "hierarchyColumns": [
        {"key": "concept_name", "width": "100%", "title": "Condition"},
        {"key": "concept_id", "width": 120, "title": "Concept ID"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "occurrence": "condition_occurrence",
      "classification": "condition"
    },
    {
      "type":"classification",
      "id": "tanagra-procedures",
      "title":"Procedure",
      "conceptSet": true,
      "category": "Domains",
      "columns": [
        {"key":"concept_name","width":"100%","title":"Concept name"},
        {"key":"concept_id","width":100,"title":"Concept ID"},
        {"key":"standard_concept","width":120,"title":"Source/standard"},
        {"key":"vocabulary_id","width":120,"title":"Vocab"},
        {"key":"concept_code","width":120,"title":"Code"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "hierarchyColumns": [
        {"key": "concept_name", "width": "100%", "title": "Procedure"},
        {"key": "concept_id", "width": 120, "title": "Concept ID"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "occurrence": "procedure_occurrence",
      "classification": "procedure"
    },
    {
      "type":"classification",
      "id": "tanagra-observations",
      "title":"Observation",
      "conceptSet": true,
      "category": "Domains",
      "columns": [
        {"key":"concept_name","width":"100%","title":"Concept name"},
        {"key":"concept_id","width":100,"title":"Concept ID"},
        {"key":"standard_concept","width":120,"title":"Source/standard"},
        {"key":"vocabulary_id","width":120,"title":"Vocab"},
        {"key":"concept_code","width":120,"title":"Code"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "occurrence": "observation_occurrence",
      "classification": "observation"
    },
    {
      "type":"classification",
      "id": "tanagra-drugs",
      "title":"Drug",
      "conceptSet": true,
      "category": "Domains",
      "columns": [
        {"key":"concept_name","width":"100%","title":"Concept name"},
        {"key":"concept_id","width":100,"title":"Concept ID"},
        {"key":"standard_concept","width":120,"title":"Source/standard"},
        {"key":"vocabulary_id","width":120,"title":"Vocab"},
        {"key":"concept_code","width":120,"title":"Code"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "hierarchyColumns": [
        {"key": "concept_name", "width": "100%", "title": "Drug"},
        {"key": "concept_id", "width": 120, "title": "Concept ID"},
        {"key":"person_count","width":120,"title":"Roll-up count"}
      ],
      "occurrence": "ingredient_occurrence",
      "classification": "ingredient"
    },
    {
      "type":"attribute",
      "id": "tanagra-ethnicity",
      "title":"Ethnicity",
      "category": "Program data",
      "attribute":"ethnicity_concept_id"
    },
    {
      "type":"attribute",
      "id": "tanagra-gender",
      "title":"Gender identity",
      "category": "Program data",
      "attribute":"gender_concept_id"
    },
    {
      "type":"attribute",
      "id": "tanagra-race",
      "title":"Race",
      "category": "Program data",
      "attribute":"race_concept_id"
    },
    {
      "type":"attribute",
      "id": "tanagra-sex_at_birth",
      "title":"Sex assigned at birth",
      "category": "Program data",
      "attribute":"sex_at_birth_concept_id"
    },
    {
      "type":"attribute",
      "id": "tanagra-year_of_birth",
      "title":"Year of birth",
      "category": "Program data",
      "attribute":"year_of_birth"

    }],
    "demographicChartConfigs": {
      "groupByAttributes": ["gender_concept_id", "race_concept_id", "year_of_birth"],
      "chartConfigs": [{
        "title": "Gender identity",
        "primaryProperties": [
          { "key": "gender" }
        ]
      },
      {
        "title": "Gender identity, Current age, Race",
        "primaryProperties": [
          { "key": "gender" },
          { "key": "age",
            "buckets": [{
              "min": 18,
              "max": 45,
              "displayName": "18-44"
            },
            {
              "min": 45,
              "max": 65,
              "displayName": "45-64"
            },
            {
              "min": 65,
              "displayName": "65+"
            }]
          }
        ],
        "stackedProperty": { "key": "race" }
      }]
    },
    "prepackagedConceptSets": [
      {
        "id": "_demographics",
        "name": "Demographics",
        "occurrence": ""
      },
      {
        "id": "_analgesics",
        "name": "Analgesics",
        "occurrence": "ingredient_occurrence",
        "filter": {
          "type": "CLASSIFICATION",
          "occurrenceID": "ingredient_occurrence",
          "classificationID": "ingredient",
          "keys": [21604253]
        }
      }
    ],
    "criteriaSearchConfig": {
      "criteriaTypeWidth": 120,
      "columns": [
        {"key":"concept_name","width":"100%","title":"Concept Name"},
        {"key":"vocabulary_id","width":120,"title":"Vocab"},
        {"key":"concept_code","width":120,"title":"Code"},
        {"key":"person_count","width":120,"title":"Roll-up Count"}
      ]
    }
  }
relationships:
  - name: person_condition_occurrence
    entity1: person
    entity2: condition_occurrence
  - name: concept_id_person_gender
    entity1: concept
    entity2: person
  - name: concept_id_person_race
    entity1: concept
    entity2: person
  - name: concept_id_person_ethnicity
    entity1: concept
    entity2: person
  - name: concept_id_person_sex_at_birth
    entity1: concept
    entity2: person
  - name: concept_id_condition
    entity1: concept
    entity2: condition_occurrence
datasets:
  - name: omop_test
    bigQueryDataset:
      projectId: broad-tanagra-dev
      datasetId: synpuf
    tables:
      - name: person
        columns:
          - name: person_id
            dataType: INT64
          - name: gender_concept_id
            dataType: INT64
          - name: race_concept_id
            dataType: INT64
          - name: ethnicity_concept_id
            dataType: INT64
      - name: condition_occurrence
        columns:
          - name: condition_occurrence_id
            dataType: INT64
          - name: person_id
            dataType: INT64
          - name: condition_concept_id
            dataType: INT64
      - name: concept
        columns:
          - name: concept_id
            dataType: INT64
          - name: concept_name
            dataType: STRING
          - name: domain_id
            dataType: STRING
          - name: standard_concept
            dataType: STRING
          - name: vocabulary_id
            dataType: STRING
          - name: concept_code
            dataType: STRING
      - name: vocabulary
        columns:
          - name: vocabulary_id
            dataType: STRING
          - name: vocabulary_name
            dataType: STRING
      - name: concept_relationship
        columns:
          - name: concept_id_1
            dataType: INT64
          - name: concept_id_2
            dataType: INT64
          - name: relationship_id
            dataType: STRING
  - name: omop_indexes
    bigQueryDataset:
      projectId: broad-tanagra-dev
      datasetId: synpuf_indexes
    tables:
      - name: flatten_snomed_conditions_0
        columns:
          - name: ancestor
            dataType: INT64
          - name: descendant
            dataType: INT64
      - name: concept_ancestor_descendant_1
        columns:
          - name: ancestor
            dataType: INT64
          - name: descendant
            dataType: INT64
      - name: concept_node_path_1
        columns:
          - name: node
            dataType: INT64
          - name: path
            dataType: STRING
entityMappings:
  - entity: person
    primaryKey:
      dataset: omop_test
      table: person
      column: person_id
  - entity: condition_occurrence
    primaryKey:
      dataset: omop_test
      table: condition_occurrence
      column: condition_occurrence_id
  - entity: concept
    primaryKey:
      dataset: omop_test
      table: concept
      column: concept_id
attributeMappings:
  - attribute:
      entity: person
      attribute: person_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: person_id
  - attribute:
      entity: person
      attribute: gender_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: gender_concept_id
  - attribute:
      entity: person
      attribute: gender
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: gender_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: person
      attribute: race_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: race_concept_id
  - attribute:
      entity: person
      attribute: race
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: race_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: person
      attribute: ethnicity_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
  - attribute:
      entity: person
      attribute: ethnicity
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: condition_occurrence
      attribute: condition_occurrence_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: condition_occurrence_id
  - attribute:
      entity: condition_occurrence
      attribute: person_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: person_id
  - attribute:
      entity: condition_occurrence
      attribute: condition_concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
  - attribute:
      entity: condition_occurrence
      attribute: condition_name
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: condition_occurrence
      attribute: condition_standard
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: standard_concept
  - attribute:
      entity: condition_occurrence
      attribute: condition_concept_code
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
      lookupTableKey:
        dataset: omop_test
        table: concept
        column: concept_id
      lookupColumn:
        dataset: omop_test
        table: concept
        column: concept_code
  - attribute:
      entity: concept
      attribute: concept_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_id
  - attribute:
      entity: concept
      attribute: concept_name
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_name
  - attribute:
      entity: concept
      attribute: domain_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: domain_id
  - attribute:
      entity: concept
      attribute: vocabulary_id
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: vocabulary_id
  - attribute:
      entity: concept
      attribute: vocabulary_name
    lookupColumn:
      primaryTableLookupKey:
        dataset: omop_test
        table: concept
        column: vocabulary_id
      lookupTableKey:
        dataset: omop_test
        table: vocabulary
        column: vocabulary_id
      lookupColumn:
        dataset: omop_test
        table: vocabulary
        column: vocabulary_name
  - attribute:
      entity: concept
      attribute: standard_concept
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: standard_concept
  - attribute:
      entity: concept
      attribute: concept_code
    simpleColumn:
      columnId:
        dataset: omop_test
        table: concept
        column: concept_code
relationshipMappings:
  - name: person_condition_occurrence
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: person
        column: person_id
      foreignKey:
        dataset: omop_test
        table: condition_occurrence
        column: person_id
  - name: concept_id_person_gender
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: gender_concept_id
  - name: concept_id_person_race
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: race_concept_id
  - name: concept_id_person_ethnicity
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: person
        column: ethnicity_concept_id
  - name: concept_id_condition
    foreignKey:
      primaryKey:
        dataset: omop_test
        table: concept
        column: concept_id
      foreignKey:
        dataset: omop_test
        table: condition_occurrence
        column: condition_concept_id
